define(["config","services/sulumedia/collection-manager","services/sulumedia/media-manager","services/sulumedia/media-router","services/sulumedia/user-settings-manager","services/sulumedia/overlay-manager","sulusecurity/services/security-checker","services/sulumedia/file-icons","text!./files.html"],function(a,b,c,d,e,f,g,h,i){"use strict";var j={instanceName:"collection"},k={children:"/admin/api/collections<% if (!!collection) { %>/<%= collection %><% } %>?locale=<%= locale %>&sortBy=title<% if (!!collection) { %>&depth=1<% } %>",media:"/admin/api/media?locale=<%= locale %><% if (!!collection) { %>&collection=<%= collection %><% } %>"},l={hideToolbarClass:"toolbar-hidden",dropzoneSelector:".dropzone-container",toolbarSelector:".list-toolbar-container",datagridSelector:".datagrid-container",childrenSelector:".children-container",collectionTitleSelector:".content-title h2"};return{stickyToolbar:240,layout:{content:{width:"max"}},initialize:function(){this.options=this.sandbox.util.extend(!0,{},j,this.options),this.data=this.options.getData(),this.bindDatagridEvents(),this.bindDropzoneEvents(),this.bindOverlayEvents(),this.bindManagerEvents(),this.bindListToolbarEvents(),this.render(),this.options.editId&&f.startEditMediaOverlay.call(this,this.options.editId,this.options.locale)},bindDatagridEvents:function(){this.sandbox.on("husky.datagrid."+this.data.id+".children.tiles.add-clicked",f.startCreateCollectionOverlay.bind(this,this.data)),this.sandbox.on("husky.datagrid.number.selections",function(a){var b=a>0?"enable":"disable";this.sandbox.emit("husky.toolbar."+this.options.instanceName+".item."+b,"media-move",!1),this.sandbox.emit("husky.toolbar."+this.options.instanceName+".item."+b,"editSelected",!1),this.sandbox.emit("husky.toolbar."+this.options.instanceName+".item."+b,"delete",!1)}.bind(this))},bindDropzoneEvents:function(){this.sandbox.on("husky.dropzone."+this.options.instanceName+".success",function(a,b){this.sandbox.emit("sulu.labels.success.show","labels.success.media-upload-desc","labels.success"),b.type=b.type.name,this.sandbox.emit("husky.datagrid.records.add",[b])},this)},bindManagerEvents:function(){this.sandbox.on("sulu.medias.media.deleted",function(a){this.sandbox.emit("husky.datagrid.record.remove",a)}.bind(this)),this.sandbox.on("sulu.medias.media.moved",function(a){this.sandbox.emit("husky.datagrid.record.remove",a)}.bind(this)),this.sandbox.on("sulu.medias.media.saved",function(a,b){b.locale&&b.locale!==this.options.locale||this.sandbox.emit("husky.datagrid.records.change",this.sandbox.util.extend(!0,{},b,{type:b.type.name?b.type.name:b.type}))}.bind(this))},bindOverlayEvents:function(){this.sandbox.on("sulu.collection-select.move-media.selected",this.moveMedia.bind(this)),this.sandbox.on("sulu.collection-add.initialized",this.disableDropzone.bind(this)),this.sandbox.on("sulu.collection-edit.initialized",this.disableDropzone.bind(this)),this.sandbox.on("sulu.collection-select.move-collection.initialized",this.disableDropzone.bind(this)),this.sandbox.on("sulu.collection-select.move-media.initialized",this.disableDropzone.bind(this)),this.sandbox.on("sulu.media-edit.initialized",this.disableDropzone.bind(this)),this.sandbox.on("sulu.permission-settings.initialized",this.disableDropzone.bind(this)),this.sandbox.on("sulu.collection-add.closed",this.enableDropzone.bind(this)),this.sandbox.on("sulu.collection-edit.closed",this.enableDropzone.bind(this)),this.sandbox.on("sulu.collection-select.move-collection.closed",this.enableDropzone.bind(this)),this.sandbox.on("sulu.collection-select.move-media.closed",this.enableDropzone.bind(this)),this.sandbox.on("sulu.media-edit.closed",this.enableDropzone.bind(this)),this.sandbox.on("sulu.permission-settings.closed",this.enableDropzone.bind(this)),this.sandbox.on("sulu.medias.collection.saved",this.savedHandler.bind(this))},bindListToolbarEvents:function(){this.sandbox.on("sulu.list-toolbar.add",function(){this.sandbox.emit("husky.dropzone."+this.options.instanceName+".show-popup")}.bind(this)),this.sandbox.on("sulu.list-toolbar.delete",this.deleteMedia.bind(this)),this.sandbox.on("sulu.list-toolbar.edit",this.editMedias.bind(this)),this.sandbox.on("sulu.list-toolbar.media-move",function(){f.startMoveMediaOverlay.call(this,this.data.id,this.options.locale)}.bind(this)),this.sandbox.on("sulu.toolbar.change.table",function(){e.setMediaListView("table"),e.setMediaListPagination("dropdown"),this.sandbox.emit("husky.datagrid.change",1,e.getDropdownPageSize(),"table",[],"dropdown"),this.sandbox.stickyToolbar.reset(this.$el)}.bind(this)),this.sandbox.on("sulu.toolbar.change.masonry",function(){e.setMediaListView("datagrid/decorators/masonry-view"),e.setMediaListPagination("infinite-scroll"),this.sandbox.emit("husky.datagrid.change",1,e.getInfinityPageSize(),"datagrid/decorators/masonry-view",null,"infinite-scroll"),this.sandbox.stickyToolbar.reset(this.$el)}.bind(this))},savedHandler:function(a,b){b.locale&&b.locale!==this.options.locale||$(l.collectionTitleSelector).text(b.title)},render:function(){this.sandbox.dom.html(this.$el,i),g.hasPermission(this.data,"add")&&this.startDropzone(),this.startChildrenTiles(),this.startDatagrid()},startChildrenTiles:function(){return this.data.hasSub?void this.sandbox.start([{name:"datagrid@husky",options:{el:this.$find(l.childrenSelector),url:_.template(k.children,{collection:this.data.id,locale:this.options.locale}),instanceName:this.data.id+".children",view:"tiles",resultKey:"collections",viewOptions:{tiles:{fields:{description:["mediaCount"]},translations:{addNew:"sulu.media.add-collection"}}},pagination:!1,actionCallback:function(a){d.toCollection(a,this.options.locale)}.bind(this),matchings:[{name:"id"},{name:"title"},{name:"mediaCount",type:"count"}]}}]):void this.$find(l.childrenSelector).remove()},startDatagrid:function(){var a=e.getMediaListView(),b=this.options.locale;this.sandbox.sulu.initListToolbarAndList.call(this,"media","/admin/api/media/fields?locale="+b+"&sortBy=created&sortOrder=desc",{el:this.$find(l.toolbarSelector),instanceName:this.options.instanceName,template:this.sandbox.sulu.buttons.get(this.getEditButtons())},{el:this.$find(l.datagridSelector),url:_.template(k.media,{collection:this.data.id,locale:b}),searchFields:["name","title","description"],view:a,pagination:e.getMediaListPagination(),resultKey:"media",actionCallback:function(a){this.editMedia(a)}.bind(this),viewOptions:{table:{actionIconColumn:"name",noImgIcon:function(a){return h.getByMimeType(a.mimeType)},badges:[{column:"title",callback:function(a,b){return a.locale!==this.options.locale?(b.title=a.locale,b):void 0}.bind(this)}]},"datagrid/decorators/masonry-view":{noImgIcon:function(a){return h.getByMimeType(a.mimeType)},locale:b}},paginationOptions:{"infinite-scroll":{reachedBottomMessage:"public.reached-list-end",scrollOffset:500}}})},getEditButtons:function(){var a=[],b={};return this.data.id&&g.hasPermission(this.data,"add")&&(b.add={options:{showTitle:!0,title:"sulu-media.upload-files",icon:"cloud-upload",callback:function(){this.sandbox.emit("sulu.list-toolbar.add")}.bind(this)}}),g.hasPermission(this.data,"edit")&&(b.editSelected={options:{callback:function(){this.sandbox.emit("sulu.list-toolbar.edit")}.bind(this)}}),g.hasPermission(this.data,"delete")&&(b.deleteSelected={options:{callback:function(){this.sandbox.emit("sulu.list-toolbar.delete")}.bind(this)}}),this.data.id&&g.hasPermission(this.data,"edit")&&a.push({id:"media-move",title:this.sandbox.translate("sulu.media.move"),callback:function(){this.sandbox.emit("sulu.list-toolbar.media-move")}.bind(this)}),a.push({type:"columnOptions"}),b.settings={options:{dropdownItems:a}},b.mediaDecoratorDropdown={},b},startDropzone:function(){this.data.id&&this.sandbox.start([{name:"dropzone@husky",options:{el:this.$find(l.dropzoneSelector),maxFilesize:a.get("sulu-media").maxFilesize,url:"/admin/api/media?collection="+this.data.id+"&locale="+this.options.locale,method:"POST",paramName:"fileVersion",overlayContainer:".content-column",instanceName:this.options.instanceName}}])},moveMedia:function(a){this.sandbox.emit("husky.datagrid.items.get-selected",function(b){c.move(b,a.id,this.options.locale),this.sandbox.emit("husky.datagrid."+this.data.id+".children.records.get",function(c){c.forEach(function(c){c.id===a.id&&this.sandbox.emit("husky.datagrid."+this.data.id+".children.records.change",_.extend(c,{mediaCount:c.mediaCount+b.length}))}.bind(this))}.bind(this))}.bind(this))},editMedias:function(){this.sandbox.emit("husky.datagrid.items.get-selected",function(a){f.startEditMediaOverlay.call(this,a,this.options.locale)}.bind(this))},editMedia:function(a){f.startEditMediaOverlay.call(this,[a],this.options.locale)},deleteMedia:function(){this.sandbox.emit("husky.datagrid.items.get-selected",function(a){this.sandbox.sulu.showDeleteDialog(function(b){b&&c["delete"](a)}.bind(this))}.bind(this))},disableDropzone:function(){this.sandbox.emit("husky.dropzone."+this.options.instanceName+".disable")},enableDropzone:function(){this.sandbox.emit("husky.dropzone."+this.options.instanceName+".enable")}}});